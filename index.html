<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ—…éŠè¨˜å¸³ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #3498db; --bg: #f8f9fa; --text: #2c3e50; --gray: #95a5a6; --danger: #e74c3c; --line: #06C755; --btn-bg: #e9ecef; --shadow: 0 10px 25px rgba(0,0,0,0.08); }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 850px; margin: 0 auto; min-height: 95vh; display: flex; flex-direction: column; }
        
        /* æ­¡è¿é é¢æ¨£å¼ */
        #welcome-screen { 
            position: fixed; inset: 0; background: linear-gradient(160deg, #ffffff 0%, #e3eeff 100%); 
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px;
        }
        .welcome-card { background: white; width: 100%; max-width: 400px; padding: 40px 25px; border-radius: 35px; box-shadow: var(--shadow); text-align: center; }
        .welcome-card h1 { font-size: 28px; margin: 0 0 10px 0; letter-spacing: 1px; }
        .welcome-card p { color: var(--gray); font-size: 15px; margin-bottom: 35px; }
        .btn-welcome { 
            width: 100%; padding: 18px; border-radius: 20px; font-size: 18px; font-weight: 700; 
            border: none; margin-bottom: 15px; cursor: pointer; transition: 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3); }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        
        /* ä¸€èˆ¬å¡ç‰‡æ¨£å¼ */
        .card { background: white; padding: 22px; border-radius: 24px; box-shadow: var(--shadow); margin-bottom: 20px; position: relative; border: 1px solid rgba(0,0,0,0.02); }
        .app-header { text-align: center; margin: 10px 0 25px 0; }
        .app-header h1 { margin: 0; font-size: 24px; color: var(--text); }
        .subtitle { font-size: 11px; color: var(--gray); text-transform: uppercase; margin-top: 5px; font-weight: bold; }
        
        h2 { margin: 0 0 18px 0; font-size: 1.25rem; border-left: 6px solid var(--primary); padding-left: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* åˆ—è¡¨èˆ‡æŒ‰éˆ• */
        .btn-pill { background: var(--btn-bg); color: #4a90e2; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .btn-pill.del { color: var(--danger); background: #fff1f0; }
        .btn-add-only { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-line-direct { background: var(--line); color: white; border: none; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1.2; display: flex; align-items: center; justify-content: center; gap: 5px; }
        
        /* è¡¨å–® */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        input, select, textarea { padding: 14px; border: 1.5px solid #f0f0f0; border-radius: 14px; font-size: 15px; width: 100%; box-sizing: border-box; outline: none; background: #fafafa; }
        input:focus { border-color: var(--primary); background: white; }
        label { font-size: 12px; color: var(--gray); font-weight: bold; margin-bottom: 6px; display: block; padding-left: 5px; }
        
        /* å…¶å®ƒ */
        .footer-signature { text-align: center; padding: 40px 0; color: #bdc3c7; font-size: 12px; line-height: 1.6; }
        .drag-handle { cursor: grab; padding: 10px 20px; color: #ccc; font-size: 24px; position: absolute; right: 0; top: 0; bottom: 0; display: flex; align-items: center; }
        .project-actions { position: absolute; left: 15px; bottom: 12px; display: flex; gap: 8px; }
        .tag { font-size: 10px; background: #f1f3f5; padding: 3px 8px; border-radius: 7px; color: #666; margin-right: 5px; display: inline-block; margin-top: 5px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: white; max-width: 420px; margin: 30px auto; padding: 30px; border-radius: 28px; text-align: center; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td, th { padding: 15px 5px; border-bottom: 1px solid #f8f9fa; text-align: left; }
        
        @media (max-width: 500px) { .form-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="welcome-screen">
    <div class="welcome-card">
        <div style="font-size: 60px; margin-bottom: 20px;">âœˆï¸</div>
        <h1>æ—…éŠè¨˜å¸³ç³»çµ±</h1>
        <p>å°ˆæ¥­ã€åŒæ­¥ã€å¤šäººå…±äº«</p>
        <button class="btn-welcome btn-primary" onclick="initNewGroup()">ï¼‹ å»ºç«‹æ–°æ—…ç¨‹ç¾¤çµ„</button>
        <button class="btn-welcome btn-outline" onclick="openJoinModal()">ğŸ“¥ åŠ å…¥ç¾æœ‰ç¾¤çµ„</button>
        <div style="margin-top: 25px; font-size: 12px; color: #bdc3c7;">v2.0 é›²ç«¯åŒæ­¥ç‰ˆæœ¬</div>
    </div>
</div>

<div class="container">
    <div id="project-screen" style="display:none;">
        <div class="app-header">
            <h1 id="display-group-code">...</h1>
            <div id="sync-status" class="subtitle">è®€å–é›²ç«¯ä¸­...</div>
        </div>
        
        <div class="card" style="text-align:center; background:linear-gradient(135deg, #f0f7ff 0%, #e6f1ff 100%); border:none;">
            <div style="font-size: 12px; color: var(--primary); font-weight:bold;">ğŸ“Š å¹´åº¦ç¸½æ”¯å‡º</div>
            <select id="yearSelect" onchange="updateYearlyTotal()" style="margin:8px 0; width:auto; border:none; background:transparent; font-weight:bold; font-size: 20px; color:var(--text); cursor:pointer; text-align: center;"></select>
            <div id="yearlyTotalDisplay" style="font-size: 32px; font-weight:800; color:var(--danger);">NT$ 0</div>
        </div>

        <div class="card">
            <h2>ğŸ—‚ï¸ æˆ‘çš„æ—…ç¨‹ <button class="btn-pill" onclick="openNewProjectModal()">+ å»ºç«‹</button></h2>
            <div id="project-list" style="min-height: 50px;"></div>
        </div>

        <div style="text-align: center;">
            <button class="btn-pill del" style="padding: 10px 20px;" onclick="exitGroup()">ğŸšª é€€å‡ºç¾¤çµ„</button>
        </div>
    </div>

    <div id="main-screen" style="display:none;">
        <div class="card">
            <h2><span id="current-project-name">...</span><button class="btn-pill" onclick="backToProjectList()">â¬…ï¸ è¿”å›</button></h2>
            <div class="form-grid">
                <div><label>æ—¥æœŸ</label><input type="date" id="date"></div>
                <div><label>å“é …</label><input type="text" id="itemName" placeholder="å¦‚ï¼šæ—©é¤"></div>
                <div><label>åˆ†é¡</label><select id="category">
                    <option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                    <option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                    <option value="å¨›æ¨‚">ğŸŸï¸ å¨›æ¨‚</option><option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select></div>
                <div><label>æ”¯ä»˜è€…</label><select id="payerSelect"></select></div>
                <div><label>é‡‘é¡</label><input type="number" id="amount" placeholder="0"></div>
                <div><label>å¹£åˆ¥</label><select id="currency" onchange="applyCurrencyRate('rate', 'currency')"></select></div>
                <div><label>åŒ¯ç‡</label><input type="number" id="rate" step="0.0001"></div>
                <div><label>æ–¹å¼</label><select id="payMethod"></select></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-add-only" onclick="addRecord(false)">åƒ…æ–°å¢</button>
                <button class="btn-line-direct" onclick="addRecord(true)">ğŸŸ¢ æ–°å¢ä¸¦åˆ†äº«</button>
            </div>
        </div>

        <div class="card" style="text-align:center;">
            <div id="totalDisplay" style="font-size:38px; font-weight:800; color:var(--danger); margin-bottom: 5px;">NT$ 0</div>
            <button class="btn-pill" onclick="prepareShareModal()" style="background:var(--primary); color:white; margin:10px 0; padding:12px 24px; font-size: 14px; border-radius: 14px;">ğŸ”— æŸ¥çœ‹/åˆ†äº«å¸³å–®</button>
            <div style="max-width:200px; margin:20px auto;"><canvas id="expenseChart"></canvas></div>
        </div>

        <div class="card">
            <h2>ğŸ“œ æ˜ç´° <button class="btn-pill" onclick="openModal('importModal')" style="background:var(--line); color:white;">ğŸ“¥ æ™ºæ…§åŒ¯å…¥</button></h2>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>æ—¥æœŸ</th><th>å“é …</th><th>é‡‘é¡(NT)</th><th style="text-align:right;">æ“ä½œ</th></tr></thead>
                    <tbody id="recordTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer-signature">
        Â© 2025 æ—…éŠè¨˜å¸³ç³»çµ±<br>
        All Rights Reserved. Designed by Alex Hong
    </div>
</div>

<div id="joinModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“¥ åŠ å…¥ç¾¤çµ„</h3>
        <p>è«‹è¼¸å…¥ 4 ä½æ•¸ç¾¤çµ„ä»£ç¢¼</p>
        <input type="text" id="joinCodeInput" maxlength="4" placeholder="ä¾‹å¦‚: A8K2" style="text-align: center; font-size: 24px; letter-spacing: 5px; text-transform: uppercase;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-add-only" onclick="joinGroup()">ç¢ºèªåŠ å…¥</button>
            <button class="btn-add-only" onclick="closeModal('joinModal')" style="background:#eee; color:#666;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="projectModal" class="modal">
    <div class="modal-content">
        <h3 id="pModalTitle">æ—…ç¨‹è¨­å®š</h3>
        <input type="hidden" id="editProjId">
        <div style="text-align:left;">
            <label>æ—…ç¨‹åç¨±</label><input type="text" id="pName" placeholder="ä¾‹å¦‚ï¼šæ±äº¬äº”å¤©å››å¤œ">
            <div class="form-grid" style="margin-top:10px;">
                <div><label>å‡ºç™¼</label><input type="date" id="pStart"></div>
                <div><label>å›ç¨‹</label><input type="date" id="pEnd"></div>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-add-only" onclick="handleProjectSubmit()">ç¢ºå®šå»ºç«‹</button>
            <button class="btn-add-only" onclick="closeModal('projectModal')" style="background:#eee; color:#666;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="importModal" class="modal"><div class="modal-content"><h3>ğŸ“¥ æ™ºæ…§åŒ¯å…¥</h3><textarea id="importInput" style="height:150px;" placeholder="è²¼ä¸Š LINE å¸³å–®å…§å®¹..."></textarea><button class="btn-add-only" style="margin-top:10px; width:100%;" onclick="parseImportText()">è§£æåŒ¯å…¥</button><button class="btn-pill" style="margin-top:10px;" onclick="closeModal('importModal')">é—œé–‰</button></div></div>
<div id="shareSelectModal" class="modal"><div class="modal-content"><h3>ğŸ“¤ åˆ†äº«</h3><a id="lineShareLink" href="#" target="_blank" class="btn-line-direct" style="text-decoration:none;">ğŸŸ¢ åˆ†äº«è‡³ LINE</a><button class="btn-add-only" style="margin-top:10px; width:100%; background:#6c757d;" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½æ–‡å­—</button><button class="btn-pill" style="margin-top:10px;" onclick="closeModal('shareSelectModal')">å–æ¶ˆ</button></div></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwDiQBb8828NuND2vun5zdubnnEoLKxXxn11M4tnIeMFunITW5BWmn-ucd23AihcI_zFw/exec";
    let projects=[], currentProjectId=null, records=[], payers=[], payMethods=[], currencies=[], myChart=null;
    let myGroupCode = localStorage.getItem('user_group_code') || "";

    // --- åˆå§‹åŒ–æµç¨‹ ---
    window.onload = async function() {
        Chart.register(ChartDataLabels);
        if (myGroupCode) {
            showProjectScreen();
        } else {
            document.getElementById('welcome-screen').style.display = 'flex';
        }
    };

    // ç”Ÿæˆ 4 ä½äº‚ç¢¼
    function generateRandomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // æ’é™¤æ˜“æ··æ·†å­—å…ƒ
        let result = '';
        for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }

    // å»ºç«‹æ–°ç¾¤çµ„
    function initNewGroup() {
        myGroupCode = generateRandomCode();
        openNewProjectModal(); // å…ˆå¡«å¯«æ—…ç¨‹è³‡è¨Š
    }

    // åŠ å…¥ç¾æœ‰ç¾¤çµ„
    function openJoinModal() { openModal('joinModal'); }
    async function joinGroup() {
        const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
        if (code.length !== 4) { alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ 4 ä½ä»£ç¢¼"); return; }
        myGroupCode = code;
        localStorage.setItem('user_group_code', myGroupCode);
        closeModal('joinModal');
        await showProjectScreen();
    }

    // é€€å‡ºç¾¤çµ„
    function exitGroup() {
        if(confirm("ç¢ºå®šè¦é€€å‡ºç›®å‰ç¾¤çµ„å—ï¼Ÿ(æœ¬åœ°å¿«å–å°‡æ¸…é™¤)")) {
            localStorage.removeItem('user_group_code');
            localStorage.removeItem('trip_projects');
            location.reload();
        }
    }

    // é¡¯ç¤ºæ—…ç¨‹æ¸…å–®ç•«é¢
    async function showProjectScreen() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('project-screen').style.display = 'block';
        document.getElementById('display-group-code').innerText = `ç¾¤çµ„ä»£ç¢¼: ${myGroupCode}`;
        
        await loadCloud(); // åŒæ­¥é›²ç«¯
        projects = JSON.parse(localStorage.getItem('trip_projects')) || [];
        loadProjectList();
        initYearSelector();
    }

    // è™•ç†æ—…ç¨‹å»ºç«‹
    async function handleProjectSubmit() {
        const id = document.getElementById('editProjId').value, 
              n = document.getElementById('pName').value, 
              s = document.getElementById('pStart').value, 
              e = document.getElementById('pEnd').value;
        if(!n || !s || !e) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
        
        if(id) { 
            const p = projects.find(x => x.id == id); Object.assign(p, { name:n, start:s, end:e }); 
        } else { 
            projects.push({ id:Date.now(), name:n, start:s, end:e }); 
        }
        
        // ç¢ºä¿å„²å­˜ç¾¤çµ„ä»£ç¢¼ä¸¦åˆ‡æ›ç•«é¢
        localStorage.setItem('user_group_code', myGroupCode);
        localStorage.setItem('trip_projects', JSON.stringify(projects)); 
        
        closeModal('projectModal');
        await showProjectScreen();
        syncCloud();
    }

    // --- é›²ç«¯æ ¸å¿ƒåŠŸèƒ½ (èˆ‡åŸæœ¬é€»è¾‘ä¸€è‡´ï¼Œä½†åŠ å…¥ groupCode åƒæ•¸) ---
    async function syncCloud() {
        if(!myGroupCode) return;
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key !== 'user_group_code' && (key.startsWith('trip_') || key.startsWith('records_') || key.startsWith('payers_') || key.startsWith('methods_') || key.startsWith('currencies_'))) {
                allData[key] = JSON.parse(localStorage.getItem(key));
            }
        }
        try {
            document.getElementById('sync-status').innerText = "é›²ç«¯åŒæ­¥ä¸­...";
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ groupCode: myGroupCode, data: allData }) });
            document.getElementById('sync-status').innerText = "é›²ç«¯åŒæ­¥å®Œæˆ";
        } catch (e) { document.getElementById('sync-status').innerText = "åŒæ­¥å¤±æ•—"; }
    }

    async function loadCloud() {
        if(!myGroupCode) return;
        try {
            const response = await fetch(`${GAS_URL}?group=${myGroupCode}`);
            const cloudData = await response.json();
            if (cloudData && typeof cloudData === 'object' && Object.keys(cloudData).length > 0) {
                Object.keys(cloudData).forEach(key => localStorage.setItem(key, JSON.stringify(cloudData[key])));
                document.getElementById('sync-status').innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
            }
        } catch (e) { console.error(e); }
    }

    // --- ä»¥ä¸‹ç‚ºåŸæœ¬çš„åŠŸèƒ½é‚è¼¯ (ä¿æŒä¸è®Š) ---
    function loadProjectList() {
        const list = document.getElementById('project-list'); 
        list.innerHTML = projects.length ? '' : '<p style="text-align:center;color:#999;margin-top:20px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•å»ºç«‹ç¬¬ä¸€è¶Ÿæ—…ç¨‹</p>';
        projects.forEach(p => {
            const s = JSON.parse(localStorage.getItem(`records_${p.id}`)) || [];
            const t = s.reduce((sum, r) => sum + Math.round(r.amount * (r.rate||1)), 0);
            const card = document.createElement('div');
            card.className = 'card'; card.setAttribute('data-id', p.id);
            card.style.cssText = "padding:20px 15px 55px 15px; margin-bottom:12px; border-left: 6px solid var(--primary);";
            card.innerHTML = `<div onclick="selectProject(${p.id})" style="cursor:pointer;"><b>${p.name}</b><br><span style="font-size:12px;color:#999;">${p.start} ~ ${p.end}</span><div style="color:var(--danger);font-weight:bold; font-size:22px; margin-top:8px;">NT$ ${t.toLocaleString()}</div></div><div class="project-actions"><button class="btn-pill" onclick="event.stopPropagation(); openEditProject(${p.id})">âš™ï¸</button></div><div class="drag-handle">â˜°</div>`;
            list.appendChild(card);
        });
        setTimeout(initSortable, 100);
    }

    function selectProject(id) {
        currentProjectId = id; const proj = projects.find(p => p.id === id); if(!proj) return;
        document.getElementById('current-project-name').innerText = proj.name;
        records = JSON.parse(localStorage.getItem(`records_${id}`)) || [];
        payers = JSON.parse(localStorage.getItem(`payers_${id}`)) || ["æœ¬äºº"];
        payMethods = JSON.parse(localStorage.getItem(`methods_${id}`)) || ["ğŸ’µ ç¾é‡‘", "ğŸ’³ åˆ·å¡"];
        currencies = JSON.parse(localStorage.getItem(`currencies_${id}`)) || [{code:'TWD', rate:1}, {code:'JPY', rate:0.21}];
        document.getElementById('project-screen').style.display='none'; document.getElementById('main-screen').style.display='block';
        syncUI(); render(); setDefaultDate();
    }

    function backToProjectList() { document.getElementById('main-screen').style.display='none'; showProjectScreen(); }
    function openModal(id) { document.getElementById(id).style.display='block'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openNewProjectModal() { document.getElementById('pModalTitle').innerText="æ–°æ—…ç¨‹ç¾¤çµ„ ("+myGroupCode+")"; document.getElementById('editProjId').value=""; openModal('projectModal'); }
    function openEditProject(id) { const p = projects.find(x => x.id === id); document.getElementById('pModalTitle').innerText="æ—…ç¨‹è¨­å®š"; document.getElementById('editProjId').value=p.id; document.getElementById('pName').value=p.name; document.getElementById('pStart').value=p.start; document.getElementById('pEnd').value=p.end; openModal('projectModal'); }
    function setDefaultDate() { document.getElementById('date').value = new Date().toISOString().split('T')[0]; }

    // (å‰©é¤˜ addRecord, render, updateChart ç­‰è¨˜å¸³é‚è¼¯å‡èˆ‡åŸæœ¬ç›¸åŒï¼Œæ•…ä¿ç•™åŸæ¨£)
    function addRecord(shouldShare) {
        const amtInput = document.getElementById('amount'), itemInput = document.getElementById('itemName'), amt = parseFloat(amtInput.value);
        if(!amt) return;
        records.push({ id:Date.now(), date:document.getElementById('date').value, item:itemInput.value||"æœªå‘½å", category:document.getElementById('category').value, amount:amt, currency:document.getElementById('currency').value, rate:parseFloat(document.getElementById('rate').value)||1, payer:document.getElementById('payerSelect').value, method:document.getElementById('payMethod').value });
        saveAndRefresh(); amtInput.value = ''; itemInput.value = '';
        if(shouldShare) { const txt = generateFullText(); window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(txt)}`; }
    }
    function saveAndRefresh() { localStorage.setItem(`records_${currentProjectId}`, JSON.stringify(records)); render(); syncCloud(); }
    function render() {
        const tbody = document.getElementById('recordTableBody'); tbody.innerHTML = ''; 
        let total = 0, stats = {};
        records.sort((a,b)=>a.date.localeCompare(b.date)).forEach(r => {
            const twd = Math.round(r.amount * r.rate); total += twd; stats[r.category] = (stats[r.category] || 0) + twd;
            tbody.innerHTML += `<tr><td>${r.date.substring(5)}</td><td><b>${r.item}</b><br><span class="tag">${r.payer}</span><span class="tag">${r.category}</span></td><td style="color:var(--danger);font-weight:bold;">$${twd.toLocaleString()}</td><td style="text-align:right;"><button class="btn-pill del" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸</button></td></tr>`;
        });
        document.getElementById('totalDisplay').innerText = `NT$ ${total.toLocaleString()}`; updateChart(stats);
    }
    function syncUI() {
        document.getElementById('payerSelect').innerHTML = payers.map(p => `<option value="${p}">${p}</option>`).join('');
        document.getElementById('payMethod').innerHTML = payMethods.map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('currency').innerHTML = currencies.map(c => `<option value="${c.code}">${c.code}</option>`).join('');
        applyCurrencyRate('rate', 'currency');
    }
    function applyCurrencyRate(rId, cId) { const c=document.getElementById(cId).value, t=currencies.find(x=>x.code===c); if(t) document.getElementById(rId).value=t.rate; }
    function updateChart(dataMap) {
        const ctx = document.getElementById('expenseChart').getContext('2d'); if(myChart) myChart.destroy();
        if(!Object.keys(dataMap).length) return;
        myChart = new Chart(ctx, { type:'doughnut', data:{ labels:Object.keys(dataMap), datasets:[{data:Object.values(dataMap), backgroundColor:['#3498db','#e74c3c','#2ecc71','#f1c40f','#9b59b6','#e67e22']}]}, options:{ plugins:{ legend:{display:false}, datalabels:{ color:'#fff', font:{weight:'bold', size:10}, formatter:(val, ctx)=>{ const total=ctx.dataset.data.reduce((a,b)=>a+b,0); return Math.round(val/total*100)+'%'; }}}});
    }
    function initYearSelector() {
        const sel = document.getElementById('yearSelect'); const yrs = new Set([new Date().getFullYear()]);
        projects.forEach(p => yrs.add(new Date(p.start).getFullYear()));
        sel.innerHTML = Array.from(yrs).sort((a,b)=>b-a).map(y => `<option value="${y}">${y} å¹´</option>`).join('');
        updateYearlyTotal();
    }
    function updateYearlyTotal() {
        const y = parseInt(document.getElementById('yearSelect').value); let t = 0;
        projects.forEach(p => { if(new Date(p.start).getFullYear() === y) { const s = JSON.parse(localStorage.getItem(`records_${p.id}`)) || []; t += s.reduce((sum, r) => sum + Math.round(r.amount * (r.rate||1)), 0); } });
        document.getElementById('yearlyTotalDisplay').innerText = `NT$ ${t.toLocaleString()}`;
    }
    function deleteRecord(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { records = records.filter(r => r.id !== id); saveAndRefresh(); } }
    function initSortable() { const listEl = document.getElementById('project-list'); Sortable.create(listEl, { handle:'.drag-handle', animation:250 }); }
</script>
</body>
</html>
