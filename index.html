<div id="group-init-overlay" style="position:fixed; inset:0; background:rgba(255,255,255,0.95); z-index:9999; display:flex; align-items:center; justify-content:center; text-align:center; padding:20px;">
    <div class="card" style="width:100%; max-width:320px;">
        <h3>ğŸ”‘ è¼¸å…¥ç¾¤çµ„ä»£ç¢¼</h3>
        <p style="font-size:12px; color:var(--gray);">è¼¸å…¥ç›¸åŒä»£ç¢¼çš„å¤¥ä¼´å³å¯åŒæ­¥è³‡æ–™</p>
        <input type="text" id="groupInput" placeholder="ä¾‹å¦‚ï¼šAlex2025" style="text-align:center; margin-bottom:15px; border:2px solid var(--primary);">
        <button class="btn-add-only" onclick="setGroupCode()" style="width:100%">é€²å…¥ç³»çµ±</button>
    </div>
</div>

<script>
    // --- æ–°å¢ç¾¤çµ„é‚è¼¯è®Šæ•¸ ---
    let myGroupCode = localStorage.getItem('user_group_code') || "";

    function setGroupCode() {
        const code = document.getElementById('groupInput').value.trim();
        if(!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
        if(confirm(`ç¢ºèªç¾¤çµ„ç‚ºã€Œ${code}ã€ï¼Ÿé€²å…¥å¾Œå°‡è®€å–è©²ç¾¤çµ„å°ˆå±¬é›²ç«¯ã€‚`)) {
            localStorage.setItem('user_group_code', code);
            location.reload(); // é‡æ–°æ•´ç†ä»¥è§¸ç™¼ loadCloud
        }
    }

    // --- ä¿®æ”¹å¾Œçš„é›²ç«¯åŠŸèƒ½ ---
    async function syncCloud() {
        if(!myGroupCode) return;
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            // æ’é™¤æ‰ç¾¤çµ„ä»£ç¢¼æœ¬èº«ï¼Œé¿å…å¯«å…¥é›²ç«¯é€ æˆæ··äº‚
            if (key !== 'user_group_code' && (key.startsWith('trip_') || key.startsWith('records_') || key.startsWith('payers_') || key.startsWith('methods_') || key.startsWith('currencies_'))) {
                allData[key] = JSON.parse(localStorage.getItem(key));
            }
        }
        try {
            document.getElementById('sync-status').innerText = "â˜ï¸ é›²ç«¯åŒæ­¥ä¸­...";
            await fetch(GAS_URL, { 
                method: "POST", 
                body: JSON.stringify({ groupCode: myGroupCode, data: allData }) 
            });
            document.getElementById('sync-status').innerText = `â˜ï¸ ç¾¤çµ„: ${myGroupCode} åŒæ­¥æˆåŠŸ`;
        } catch (e) {
            document.getElementById('sync-status').innerText = "âŒ åŒæ­¥å¤±æ•—";
        }
    }

    async function loadCloud() {
        if(!myGroupCode) {
            document.getElementById('group-init-overlay').style.display = 'flex';
            return;
        }
        document.getElementById('group-init-overlay').style.display = 'none';
        
        try {
            // åœ¨ç¶²å€å¾Œé¢å¸¶å…¥ç¾¤çµ„åƒæ•¸
            const response = await fetch(`${GAS_URL}?group=${encodeURIComponent(myGroupCode)}`);
            const cloudData = await response.json();
            if (cloudData && typeof cloudData === 'object' && Object.keys(cloudData).length > 0) {
                Object.keys(cloudData).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(cloudData[key]));
                });
                document.getElementById('sync-status').innerText = `â˜ï¸ å·²åŒæ­¥ç¾¤çµ„: ${myGroupCode}`;
                return true;
            }
        } catch (e) {
            console.error("è®€å–å¤±æ•—", e);
        }
        return false;
    }
</script>
