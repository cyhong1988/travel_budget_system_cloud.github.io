<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ—…éŠè¨˜å¸³ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #3498db; --bg: #f8f9fa; --text: #2c3e50; --gray: #95a5a6; --danger: #e74c3c; --line: #06C755; --btn-bg: #e9ecef; --shadow: 0 10px 25px rgba(0,0,0,0.08); }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 850px; margin: 0 auto; min-height: 95vh; display: flex; flex-direction: column; }
        
        /* æ­¡è¿é é¢æ¨£å¼ */
        #welcome-screen { 
            position: fixed; inset: 0; background: linear-gradient(160deg, #ffffff 0%, #e3eeff 100%); 
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px;
        }
        .welcome-card { background: white; width: 100%; max-width: 400px; padding: 40px 25px; border-radius: 35px; box-shadow: var(--shadow); text-align: center; }
        .welcome-card h1 { font-size: 28px; margin: 0 0 10px 0; letter-spacing: 1px; }
        .welcome-card p { color: var(--gray); font-size: 15px; margin-bottom: 35px; }
        .btn-welcome { 
            width: 100%; padding: 18px; border-radius: 20px; font-size: 18px; font-weight: 700; 
            border: none; margin-bottom: 15px; cursor: pointer; transition: 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3); }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        
        /* ä¸€èˆ¬å¡ç‰‡æ¨£å¼ */
        .card { background: white; padding: 22px; border-radius: 24px; box-shadow: var(--shadow); margin-bottom: 20px; position: relative; border: 1px solid rgba(0,0,0,0.02); }
        .app-header { text-align: center; margin: 10px 0 25px 0; }
        .app-header h1 { margin: 0; font-size: 22px; color: var(--text); }
        .subtitle { font-size: 11px; color: var(--gray); text-transform: uppercase; margin-top: 5px; font-weight: bold; }
        
        h2 { margin: 0 0 18px 0; font-size: 1.25rem; border-left: 6px solid var(--primary); padding-left: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn-pill { background: var(--btn-bg); color: #4a90e2; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .btn-pill.del { color: var(--danger); background: #fff1f0; }
        .btn-add-only { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
        
        /* è¡¨å–® */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        input, select, textarea { padding: 14px; border: 1.5px solid #f0f0f0; border-radius: 14px; font-size: 15px; width: 100%; box-sizing: border-box; outline: none; background: #fafafa; }
        label { font-size: 12px; color: var(--gray); font-weight: bold; margin-bottom: 6px; display: block; padding-left: 5px; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: white; max-width: 420px; margin: 80px auto; padding: 30px; border-radius: 28px; text-align: center; position: relative; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td, th { padding: 15px 5px; border-bottom: 1px solid #f8f9fa; text-align: left; }
        .tag { font-size: 10px; background: #f1f3f5; padding: 3px 8px; border-radius: 7px; color: #666; margin-right: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="welcome-screen">
    <div class="welcome-card">
        <div style="font-size: 60px; margin-bottom: 20px;">âœˆï¸</div>
        <h1>æ—…éŠè¨˜å¸³ç³»çµ±</h1>
        <p>å°ˆæ¥­ã€åŒæ­¥ã€å¤šäººå…±äº«</p>
        <button class="btn-welcome btn-primary" onclick="initNewGroupFlow()">ï¼‹ å»ºç«‹æ–°æ—…ç¨‹ç¾¤çµ„</button>
        <button class="btn-welcome btn-outline" onclick="openJoinModal()">ğŸ“¥ åŠ å…¥ç¾æœ‰ç¾¤çµ„</button>
        <div id="loading-hint" style="display:none; color: var(--primary); font-weight: bold; margin-top: 10px;">ğŸ” æª¢æŸ¥ä¸­...</div>
    </div>
</div>

<div class="container">
    <div id="project-screen" style="display:none;">
        <div class="app-header">
            <h1 id="display-group-code">ç¾¤çµ„ä»£ç¢¼: ----</h1>
            <div id="sync-status" class="subtitle">è®€å–é›²ç«¯ä¸­...</div>
        </div>
        
        <div class="card" style="text-align:center; background:linear-gradient(135deg, #f0f7ff 0%, #e6f1ff 100%); border:none;">
            <div style="font-size: 12px; color: var(--primary); font-weight:bold;">ğŸ“Š å¹´åº¦ç¸½æ”¯å‡º</div>
            <select id="yearSelect" onchange="updateYearlyTotal()" style="margin:8px 0; width:auto; border:none; background:transparent; font-weight:bold; font-size: 20px; color:var(--text); cursor:pointer; text-align: center;"></select>
            <div id="yearlyTotalDisplay" style="font-size: 32px; font-weight:800; color:var(--danger);">NT$ 0</div>
        </div>

        <div class="card">
            <h2>ğŸ—‚ï¸ æˆ‘çš„æ—…ç¨‹ <button class="btn-pill" onclick="openNewProjectModal()">+ å»ºç«‹</button></h2>
            <div id="project-list"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-pill del" style="padding: 10px 20px;" onclick="exitGroup()">ğŸšª é€€å‡ºä¸¦æ›´æ›ç¾¤çµ„</button>
        </div>
    </div>

    <div id="main-screen" style="display:none;">
        <div class="card">
            <h2><span id="current-project-name">...</span><button class="btn-pill" onclick="backToProjectList()">â¬…ï¸ è¿”å›</button></h2>
            <div class="form-grid">
                <div><label>æ—¥æœŸ</label><input type="date" id="date"></div>
                <div><label>å“é …</label><input type="text" id="itemName" placeholder="å¦‚ï¼šæ—©é¤"></div>
                <div><label>åˆ†é¡</label><select id="category"><option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="å¨›æ¨‚">ğŸŸï¸ å¨›æ¨‚</option><option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option></select></div>
                <div><label>æ”¯ä»˜è€…</label><select id="payerSelect"></select></div>
                <div><label>é‡‘é¡</label><input type="number" id="amount" placeholder="0"></div>
                <div><label>å¹£åˆ¥</label><select id="currency" onchange="applyCurrencyRate('rate', 'currency')"></select></div>
                <div><label>åŒ¯ç‡</label><input type="number" id="rate" step="0.0001"></div>
                <div><label>æ–¹å¼</label><select id="payMethod"></select></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-add-only" onclick="addRecord(false)">åƒ…æ–°å¢</button>
                <button class="btn-add-only" onclick="addRecord(true)" style="background:var(--line);">ğŸŸ¢ æ–°å¢ä¸¦åˆ†äº«</button>
            </div>
        </div>
        <div class="card" style="text-align:center;">
            <div id="totalDisplay" style="font-size:38px; font-weight:800; color:var(--danger); margin-bottom: 5px;">NT$ 0</div>
            <div style="max-width:200px; margin:20px auto;"><canvas id="expenseChart"></canvas></div>
        </div>
        <div class="card"><h2>ğŸ“œ æ˜ç´°</h2><div style="overflow-x:auto;"><table><thead><tr><th>æ—¥æœŸ</th><th>å“é …</th><th>é‡‘é¡(NT)</th><th style="text-align:right;">æ“ä½œ</th></tr></thead><tbody id="recordTableBody"></tbody></table></div></div>
    </div>
</div>

<div id="joinModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“¥ åŠ å…¥ç¾¤çµ„</h3>
        <p>è«‹è¼¸å…¥ 4 ä½æ•¸ç¾¤çµ„ä»£ç¢¼</p>
        <input type="text" id="joinCodeInput" maxlength="4" placeholder="A8K2" style="text-align: center; font-size: 24px; letter-spacing: 5px; text-transform: uppercase;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="btnConfirmJoin" class="btn-add-only" onclick="confirmJoinGroup()">ç¢ºèªåŠ å…¥</button>
            <button class="btn-add-only" onclick="closeModal('joinModal')" style="background:#eee; color:#666;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="projectModal" class="modal">
    <div class="modal-content">
        <h3 id="pModalTitle">å»ºç«‹æ–°æ—…ç¨‹</h3>
        <input type="hidden" id="editProjId">
        <div style="text-align:left;">
            <label>æ—…ç¨‹åç¨±</label><input type="text" id="pName" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ç§‹å­£åœ˜">
            <div class="form-grid" style="margin-top:10px;">
                <div><label>å‡ºç™¼</label><input type="date" id="pStart"></div>
                <div><label>å›ç¨‹</label><input type="date" id="pEnd"></div>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-add-only" onclick="handleProjectSubmit()">ç¢ºå®šå»ºç«‹</button>
            <button class="btn-add-only" onclick="closeModal('projectModal')" style="background:#eee; color:#666;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwDiQBb8828NuND2vun5zdubnnEoLKxXxn11M4tnIeMFunITW5BWmn-ucd23AihcI_zFw/exec";
    let projects=[], currentProjectId=null, records=[], payers=[], payMethods=[], currencies=[], myChart=null;
    let tempGroupCode = "";

    window.onload = function() {
        Chart.register(ChartDataLabels);
        const savedCode = localStorage.getItem('user_group_code');
        if (savedCode) {
            enterGroup(savedCode);
        } else {
            document.getElementById('welcome-screen').style.display = 'flex';
        }
    };

    // åŠ å…¥ç¾¤çµ„æµç¨‹ï¼šåŠ å…¥å­˜åœ¨æ€§æª¢æŸ¥
    async function confirmJoinGroup() {
        const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
        if (code.length !== 4) { alert("è«‹è¼¸å…¥ 4 ä½ä»£ç¢¼"); return; }
        
        const btn = document.getElementById('btnConfirmJoin');
        btn.innerText = "é©—è­‰ä¸­...";
        btn.disabled = true;

        try {
            const response = await fetch(`${GAS_URL}?group=${code}`);
            const cloudData = await response.json();
            
            // é—œéµæª¢æŸ¥ï¼šå¦‚æœé›²ç«¯å›å‚³è³‡æ–™å®Œå…¨ç‚ºç©ºï¼Œè¡¨ç¤ºä»£ç¢¼ä¸å­˜åœ¨
            if (!cloudData || Object.keys(cloudData).length === 0) {
                alert("æ­¤æ—…éŠç¾¤çµ„ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢ºã€‚");
                btn.innerText = "ç¢ºèªåŠ å…¥";
                btn.disabled = false;
                return;
            }

            // å­˜åœ¨ï¼Œå‰‡é€²å…¥
            closeModal('joinModal');
            enterGroup(code);
        } catch (e) {
            alert("ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            btn.innerText = "ç¢ºèªåŠ å…¥";
            btn.disabled = false;
        }
    }

    async function enterGroup(code) {
        localStorage.setItem('user_group_code', code);
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('project-screen').style.display = 'block';
        document.getElementById('display-group-code').innerText = `ç¾¤çµ„ä»£ç¢¼: ${code}`;
        
        await loadCloud(); // æ­¤è™•æœƒè™•ç†è®€å–ä¸­ç‹€æ…‹
        projects = JSON.parse(localStorage.getItem('trip_projects')) || [];
        loadProjectList();
        initYearSelector();
    }

    async function loadCloud() {
        const code = localStorage.getItem('user_group_code');
        const status = document.getElementById('sync-status');
        status.innerText = "â˜ï¸ æ­£åœ¨èˆ‡é›²ç«¯åŒæ­¥...";
        try {
            const response = await fetch(`${GAS_URL}?group=${code}`);
            const cloudData = await response.json();
            if (cloudData && Object.keys(cloudData).length > 0) {
                Object.keys(cloudData).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(cloudData[key]));
                });
                status.innerText = "â˜ï¸ å·²åŒæ­¥æœ€æ–°è³‡æ–™";
            } else {
                status.innerText = "â˜ï¸ é›²ç«¯å°šç„¡è³‡æ–™";
            }
        } catch (e) {
            status.innerText = "âš ï¸ ç›®å‰è™•æ–¼é›¢ç·šæ¨¡å¼";
        }
    }

    // (å…¶é¤˜å»ºç«‹ã€è¨˜å¸³åŠŸèƒ½é‚è¼¯ä¿æŒç©©å®šä¸è®Š...)
    function generateRandomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let result = '';
        for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }

    function initNewGroupFlow() {
        tempGroupCode = generateRandomCode();
        document.getElementById('pModalTitle').innerText = "å»ºç«‹æ–°ç¾¤çµ„ (" + tempGroupCode + ")";
        openModal('projectModal');
    }

    function openJoinModal() { openModal('joinModal'); }
    function exitGroup() { if(confirm("ç¢ºå®šé€€å‡ºï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function openModal(id) { document.getElementById(id).style.display='block'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openNewProjectModal() { document.getElementById('editProjId').value = ""; document.getElementById('pName').value = ""; openModal('projectModal'); }

    async function handleProjectSubmit() {
        const n = document.getElementById('pName').value;
        const s = document.getElementById('pStart').value;
        const e = document.getElementById('pEnd').value;
        if(!n || !s || !e) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }

        if(!localStorage.getItem('user_group_code')) {
            localStorage.setItem('user_group_code', tempGroupCode);
        }
        
        projects = JSON.parse(localStorage.getItem('trip_projects')) || [];
        projects.push({ id:Date.now(), name:n, start:s, end:e });
        localStorage.setItem('trip_projects', JSON.stringify(projects));
        
        closeModal('projectModal');
        enterGroup(localStorage.getItem('user_group_code'));
        syncCloud();
    }

    async function syncCloud() {
        const code = localStorage.getItem('user_group_code');
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.includes('_')) allData[key] = JSON.parse(localStorage.getItem(key));
        }
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ groupCode: code, data: allData }) });
    }

    function loadProjectList() {
        const list = document.getElementById('project-list');
        list.innerHTML = projects.length ? '' : '<p style="text-align:center;color:#999;">å°šæœªå»ºç«‹æ—…ç¨‹</p>';
        projects.forEach(p => {
            const s = JSON.parse(localStorage.getItem(`records_${p.id}`)) || [];
            const t = s.reduce((sum, r) => sum + Math.round(r.amount * (r.rate||1)), 0);
            const card = document.createElement('div');
            card.className = 'card'; card.style.padding = "20px 15px 50px 15px";
            card.innerHTML = `<div onclick="selectProject(${p.id})"><b>${p.name}</b><br><small>${p.start}~${p.end}</small><div style="color:var(--danger);font-weight:bold;font-size:20px;margin-top:5px;">NT$ ${t.toLocaleString()}</div></div>`;
            list.appendChild(card);
        });
    }

    function selectProject(id) {
        currentProjectId = id;
        const proj = projects.find(p => p.id === id);
        document.getElementById('current-project-name').innerText = proj.name;
        records = JSON.parse(localStorage.getItem(`records_${id}`)) || [];
        payers = JSON.parse(localStorage.getItem(`payers_${id}`)) || ["æœ¬äºº"];
        payMethods = JSON.parse(localStorage.getItem(`methods_${id}`)) || ["ğŸ’µ ç¾é‡‘", "ğŸ’³ åˆ·å¡"];
        currencies = JSON.parse(localStorage.getItem(`currencies_${id}`)) || [{code:'TWD', rate:1}, {code:'JPY', rate:0.21}];
        document.getElementById('project-screen').style.display='none';
        document.getElementById('main-screen').style.display='block';
        syncUI(); render(); setDefaultDate();
    }

    function backToProjectList() { document.getElementById('main-screen').style.display='none'; document.getElementById('project-screen').style.display='block'; loadProjectList(); }
    function syncUI() {
        document.getElementById('payerSelect').innerHTML = payers.map(p => `<option value="${p}">${p}</option>`).join('');
        document.getElementById('payMethod').innerHTML = payMethods.map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('currency').innerHTML = currencies.map(c => `<option value="${c.code}">${c.code}</option>`).join('');
        applyCurrencyRate('rate', 'currency');
    }
    function applyCurrencyRate(rId, cId) { 
        const c=document.getElementById(cId).value;
        const t=currencies.find(x=>x.code===c);
        if(t) document.getElementById(rId).value=t.rate;
    }
    function setDefaultDate() { document.getElementById('date').value = new Date().toISOString().split('T')[0]; }
    function addRecord(shouldShare) {
        const amt = parseFloat(document.getElementById('amount').value);
        if(!amt) return;
        records.push({ id: Date.now(), date: document.getElementById('date').value, item: document.getElementById('itemName').value || "æœªå‘½å", category: document.getElementById('category').value, amount: amt, currency: document.getElementById('currency').value, rate: parseFloat(document.getElementById('rate').value) || 1, payer: document.getElementById('payerSelect').value, method: document.getElementById('payMethod').value });
        localStorage.setItem(`records_${currentProjectId}`, JSON.stringify(records));
        render(); syncCloud();
        document.getElementById('amount').value = ""; document.getElementById('itemName').value = "";
    }
    function render() {
        const tbody = document.getElementById('recordTableBody'); tbody.innerHTML = '';
        let total = 0, stats = {};
        records.forEach(r => {
            const twd = Math.round(r.amount * r.rate); total += twd; stats[r.category] = (stats[r.category] || 0) + twd;
            tbody.innerHTML += `<tr><td>${r.date.substring(5)}</td><td><b>${r.item}</b><br><span class="tag">${r.payer}</span></td><td>$${twd.toLocaleString()}</td><td style="text-align:right;"><button class="btn-pill del" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸</button></td></tr>`;
        });
        document.getElementById('totalDisplay').innerText = `NT$ ${total.toLocaleString()}`; updateChart(stats);
    }
    function deleteRecord(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { records = records.filter(x => x.id !== id); localStorage.setItem(`records_${currentProjectId}`, JSON.stringify(records)); render(); syncCloud(); } }
    function updateChart(dataMap) {
        const ctx = document.getElementById('expenseChart').getContext('2d'); if(myChart) myChart.destroy();
        if(!Object.keys(dataMap).length) return;
        myChart = new Chart(ctx, { type:'doughnut', data:{ labels:Object.keys(dataMap), datasets:[{data:Object.values(dataMap), backgroundColor:['#3498db','#e74c3c','#2ecc71','#f1c40f','#9b59b6']}] }, options:{plugins:{legend:{display:false},datalabels:{color:'#fff',font:{weight:'bold'}}}}});
    }
    function initYearSelector() {
        const sel = document.getElementById('yearSelect'); const yrs = [new Date().getFullYear()];
        projects.forEach(p => yrs.push(new Date(p.start).getFullYear()));
        const uniqueYrs = [...new Set(yrs)].sort((a,b)=>b-a);
        sel.innerHTML = uniqueYrs.map(y => `<option value="${y}">${y} å¹´</option>`).join('');
        updateYearlyTotal();
    }
    function updateYearlyTotal() {
        const y = parseInt(document.getElementById('yearSelect').value); let t = 0;
        projects.forEach(p => { if(new Date(p.start).getFullYear() === y) { const s = JSON.parse(localStorage.getItem(`records_${p.id}`)) || []; t += s.reduce((sum, r) => sum + Math.round(r.amount * (r.rate||1)), 0); } });
        document.getElementById('yearlyTotalDisplay').innerText = `NT$ ${t.toLocaleString()}`;
    }
</script>
</body>
</html>
